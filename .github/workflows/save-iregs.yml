name: Save iregs as text

on:
  workflow_dispatch:
  schedule:
    - cron: '2 8 * * 1'

env:
  #PARTS: "1002,1003,1004,1005,1006,1007,1008,1010,1011,1012,1013,1016,1022,1024,1026,1030,1041"
  PARTS: "1004,1006"

jobs:
  save-iregs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Installs htmlq
        uses: baptiste0928/cargo-install@v3.0.0
        with:
          crate: htmlq
          version: "0.4.0"

      - name: Fetch and extract parts from iRegs
        run: |
          IFS="," read -a BASH_PARTS <<< "$PARTS"
          for PART in "${BASH_PARTS[@]}"; do
            echo "$PART"
            CHUNKS=($(curl -sSL https://www.consumerfinance.gov/rules-policy/regulations/${PART}/" | htmlq -t | htmlq -t '.o-secondary-nav_link' -a href -b https://www.consumerfinance.gov))
            curl -sSL "$CHUNKS" | htmlq -r '.regulation-meta, .inline-interpretation, .block__sub' | htmlq -t '.u-layout-grid_main' | sed '/^ *$/d' | awk '{$1=$1};1' > "./iregs/${PART}.txt"
          done

      - name:  Test
        run: |
          ls -l iregs
          cat iregs/1004.txt
          #- name: Commit text
          #uses: stefanzweifel/git-auto-commit-action@v5.0.0
          #with:
          #commit_message: Nightly update
